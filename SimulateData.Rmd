---
title: "Simulate data"
output:
  html_document:
    df_print: paged
---

* Assume a hazard model of the form: $h(t) = \lambda_0 \cdot \left( 1 + \frac{\text{EMAX} \cdot C(t)}{EC50 + C(t)} \right)$
* Assume 2\% event rate over 6 months on placebo and 30% event rate if $C(t) >> EC50$
* Implies $\lambda_0 = -\log(0.02)/180$ and $\theta = 1 - \log(0.30)/\log(0.02)$
* PK model: $V (L) = 3.5*(WT/70)*exp(\eta_V)$, $CL (L/day) = 0.5*(WT/70)^{0.75}*\exp(\eta_{CL})/24$

Study with doses of 0, 5, 10, 20, 40 mg, IV bolus.  50 subjects per arm.  10% uniform drop-out; independent of AE hazard.

```{r}
library(tidyverse)
library(survival)
library(mrgsolve)
library(survminer)

theme_set(theme_bw())

set.seed(1234)

n_per_dose = 50
doses = c(0,5,10,20,40)
n_total = n_per_dose * length(doses)


levels.dose = c("Placebo",paste0(doses[-1]," (mg)"))
levels.ecog = c("ECOG Status = 0","ECOG Status = 1","ECOG Status > 1")

## time units = days

dsim = tibble(ID = 1:n_total,
              dose = rep(doses, each=n_per_dose),
              dosef = factor(ifelse(dose>0,paste0(dose," (mg)"),"Placebo"),levels=levels.dose),
              BWT = rlnorm(n_total, meanlog = log(80), sdlog = 0.2),
              AGE = rnorm(n_total, 40, 5),
              cAGE = AGE-40,
              eta_V = rnorm(n_total,0,0.30),
              eta_CL = rnorm(n_total, 0, 0.30),
              eta_KA = rnorm(n_total, 0.30),
              ECOGN = sample(c(0:2),size=250,replace=TRUE,prob=c(.60,.30,.10)),
              ECOGF = factor(case_when(ECOGN==0~"ECOG Status = 0",
                                       ECOGN==1~"ECOG Status = 1",
                                       ECOGN==2~"ECOG Status > 1"),levels=levels.ecog),
              ECOG1 = ifelse(ECOGN==1,1,0),
              ECOG2 = ifelse(ECOGN>1,1,0),
              TIMEDO = sample(c(0:1),size=250,replace=TRUE,prob=c(.90,.10))) %>% 
  # 10% of subjets drop out otherwise they have DO TIME of 180 days (~ administrative censoring)
  mutate(TIMEDO = ifelse(TIMEDO,runif(1,0,180),180)) 

dsim = dsim %>% 
  mutate(VC = 4.5 * (BWT/70) * exp(eta_V),
         CL = 0.5  * (BWT/70)^0.75 * exp(eta_CL) * 24,
         KA = (0.92*24) * exp(eta_KA),
         EC50 = 2, 
         LAMBDA0 = -log(0.98)/180,
         EMAX = log(.50)/log(.98)-1,
         evid=1,
         amt=dose,
         time=0,
         ii=1,
         addl = 180,
         cmt=1,
         u_ae = runif(n_total))


```


```{r}
mod <- mread_cache(model = "Day1",project = 'model/mrgsolve/')
```

```{r}
dout = mod %>% 
  data_set(dsim) %>% 
  carry_out(dose,KA,CL,VC,LAMBDA0,u_ae,TIMEDO,ECOG1,ECOG2,cAGE) %>% 
  mrgsim_df(del=1/24) %>% 
  mutate(Surv = exp(-CHAZARD)) %>% 
  left_join(dsim %>% distinct(ID,ECOGF,dosef))

# lets simulate AE time
# subjects not observed to have an AE time are given an AE time of 180 days 
dout = dout %>% 
  group_split(ID) %>% 
  lapply(function(x) {
        x %>% mutate(TIMEAE=suppressWarnings(approx(x=1-x$Surv,y=x$time,xout=x$u_ae[1],yright=180)$y))
  }) %>% bind_rows() %>% 
  # taking into consideration censoring/drop out
  mutate(TIMEAE=ifelse(TIMEAE<TIMEDO,TIMEAE,TIMEDO),
         # indicator of whether subject had AE
         AE=ifelse(TIMEAE<TIMEDO,1,0))


```


```{r}
dout %>% 
  filter(time <10) %>% 
  ggplot(aes(x=time, y=CENT, group=ID, col=as.factor(dose))) +
  geom_line() +
  facet_wrap(~dose)+
  theme_bw()
```


```{r}
dout %>% 
  filter(ID %in% seq(1,201,by=50)) %>% 
  ggplot(aes(x=time, y=Surv, group=ID, col=as.factor(dose))) +
  geom_line() +
  theme_bw()
```

```{r}
dae = dout %>% 
  filter(Surv > u_ae) %>% 
  group_by(ID) %>% 
  slice(n()) %>% 
  mutate(AE = as.numeric(time < 180))
```

```{r}
dae %>% group_by(dose) %>% summarise(p=mean(AE))
```


# Boxplots of CAVGSS by dose group
```{r}
dout = dout %>% 
    mutate(CAVGSS=dose/CL) 

dout %>% 
  ggplot() + 
  geom_boxplot(aes(y=CAVGSS,x=dosef)) + 
  labs(y=expression(C["ave,ss"]),
       x="Dose (mg)")
```

# Plot AE prob vs CAVGSS
```{r}

dat.AE = dout %>% 
  distinct(ID,TIMEAE,AE,CAVGSS,dosef,ECOGF,cAGE)

dout %>% 
  filter(time==180) %>% 
  ggplot() + 
  geom_smooth(aes(y=1-Surv,x=CAVGSS,color="True probability"),se=FALSE) +
     geom_rug(data = dat.AE %>% filter(AE == 0),
              aes(x = CAVGSS), sides = "b") +
     geom_rug(data = dat.AE %>% filter(AE == 1),
              aes(x = CAVGSS), sides = "t") +
     geom_smooth(data = dat.AE,
                 aes(x = CAVGSS, y = AE, color="Estimated probability from data"),
                 se=FALSE,
                 method = "glm",
                 method.args = list(family="binomial")) + 
  labs(x=expression(C["ave,ss"]),
       y="Probability of AE",
       color="Smoothed Probability") + 
  ylim(c(0,1))
```


# Plot time to AE by dose group

```{r}
sfit <- survfit(Surv(TIMEAE, AE) ~ dosef, data = dat.AE)
p <- ggsurvplot(sfit,
                fun="event",
                data=dat.AE,
                ggtheme=theme_bw(),
                conf.int = FALSE,
                legend.labs=levels.dose,
                legend.title="Doses",
                xlab = "Time (days)", 
                ylab = "Probability of AE",
                ylim=c(0,1))
p  
```

# Plot time to AE by CAVGSS quartile
```{r}
dat.AE = dat.AE %>% 
mutate(Quartile = factor(paste0("Q", ntile(CAVGSS, n = 4)))) 

sfit <- survfit(Surv(TIMEAE, AE) ~ Quartile, data = dat.AE)
p <- ggsurvplot(sfit,
                fun="event",
                  data=dat.AE,
                ggtheme=theme_bw(),
                conf.int = FALSE,
                legend.labs=levels(dat.AE$Quartile),
                legend.title=expression("Quartiles of C"["ave,ss"]),
                xlab = "Time (days)", 
                ylab = "Probability of AE",
                ylim=c(0,1))
p  
```

# Plot time to AE by ECOG status

```{r}
sfit <- survfit(Surv(TIMEAE, AE) ~ ECOGF, data = dat.AE)
p <- ggsurvplot(sfit,
                fun="event",
                data=dat.AE,
                ggtheme=theme_bw(),
                conf.int = FALSE,
                legend.labs=levels.ecog,
                legend.title="Doses",
                xlab = "Time (days)", 
                ylab = "Probability of AE",
                ylim=c(0,1))
p  
```


# Plot time to AE by AGE quartile
```{r}
dat.AE = dat.AE %>% 
mutate(Quartile = cut(cAGE+40,breaks=c(0,35,40,45,100))) 

sfit <- survfit(Surv(TIMEAE, AE) ~ Quartile, data = dat.AE)
p <- ggsurvplot(sfit,
                fun="event",
                  data=dat.AE,
                ggtheme=theme_bw(),
                conf.int = FALSE,
                legend.labs=levels(dat.AE$Quartile),
                legend.title=expression("Quartiles of AGE"),
                xlab = "Time (days)", 
                ylab = "Probability of AE",
                ylim=c(0,1))
p  
```





